configuration:
  dependencies:
  - "mvn://com.walmartlabs.concord.plugins.basic:crypto-tasks:0.66.1-SNAPSHOT"
  - "mvn://com.walmartlabs.concord.plugins.basic:smtp-tasks:0.66.1-SNAPSHOT"
  - "mvn://com.walmartlabs.concord.plugins:jira-task:0.41.1-SNAPSHOT"
  - "mvn://org.codehaus.groovy:groovy-all:2.4.12"
  arguments:
    smtpParams:
      host: smtp-gw1.wal-mart.com
      port: 25
    emailText : error.moustache
    baseUrl: http://localhost:8001/api/v1/
    senderEmail: humna.naeem@confiz.com
    TeamUserList: "[]"
    userName: cn=myuser
    passwordKey: u+lZMQVnqd8u+VWguVklLQ==
    jiraConfig:
      jiraUrl: "https://confiz.atlassian.net"
      jiraUid: "humna.naeem@confiz.com"
      jiraPwd: "g00dbuddy"
      jiraProjectKey: "CON"
      reporter: "humna.naeem"
      jiraRequestorUid: "humna.naeem"
      jiraIssueTypeId: 10900
      jiraTransitionId: 2
      jiraTransitionComment: "Request rejected from the admin"
      
      
    
    

flows:
  default:
  - log: ${requestInfo}
  - task: http
    in:
       method: GET
       auth:
        basic:
          username: cn=myuser
          password: q1
       url: ${baseUrl}org/default/inventory/${requestInfo.query.inventoryName}/data/itemPath
       request: json
       response: json
       out: inventoryResponseData
  - log: ${inventoryResponseData}
  - set:
      jiraConfig:
          jiraIssueKey: ${inventoryResponseData.jiraIssueKey}
  - task: http
    in:
      method: POST
      auth:
        basic:
          username: cn=myuser
          password: q1
      url: ${baseUrl}user
      body:
        username : ${initiator.username}
      request: json
      response: json
      out: rsp
  - log: ${rsp}
  - if: ${rsp.success}
    then:
    - if: ${inventoryResponseData.requestType == "create"}
      then:
      - CreateOrganizationFlow

    - if: ${inventoryResponseData.requestType == "join"}
      then:
      - JoinOrganizationRequest
  - Email



  CreateOrganizationFlow:
      - form: adminformCreateOrganization
      - set:
           emailText: "reject.moustache"
      - if: ${adminformCreateOrganization.accept == "accept"}
        then:
        - set:
            emailText: "createTeamFailes.moustache"
        - task: http
          in:
            method: POST
            auth:
              basic:
                username: cn=myuser
                password: q1
            body:
              name: ${inventoryResponseData.org}
            url: ${baseUrl}org
            request: json
            response: json
            out: orgrespone
        - log: ${orgrespone}
        - if: ${orgrespone.success}
          then:
          - script: groovy
            body: |
              import groovy.json.JsonSlurper
              import groovy.json.JsonBuilder
              def userArray = inventoryResponseData.userlist.split(',')

              def addTeamUserlist = "["
              for (String user : userArray) {
                    if(addTeamUserlist != "["){
                    addTeamUserlist = addTeamUserlist + ',{"username":"'+user+'"}'
                    }else{
                    addTeamUserlist = addTeamUserlist + '{"username":"'+user+'"}'
                    }
              }

              addTeamUserlist = addTeamUserlist+"]"
              execution.setVariable("TeamUserList",addTeamUserlist);
          - task: http
            in:
              method: PUT
              auth:
                basic:
                  username: cn=myuser
                  password: q1
              body: ${TeamUserList}
              url: ${baseUrl}org/${inventoryResponseData.org}/team/default/users
              response: json
              request: json
              out: addUserTeamResponse
          - if: ${addUserTeamResponse.success}
            then:
            - set:
                emailText: "createTeamSuccess.moustache"
               
        
  JoinOrganizationRequest:
      - form: adminformJoinOrganization   
      - set:
          emailText: "reject.moustache"
      - if: ${adminformJoinOrganization.accept == "accept"}
        then:
        - set:
            emailText: "joinTeamFailes.moustache"
        - task: http
          in:
            method: PUT
            auth:
              basic:
                username: cn=myuser
                password: q1
            body: '[{"username":"${requestedUser}"}]'
            url: ${baseUrl}/org/Default/team/${inventoryResponseData.selectedOrg}/users
            response: json
            request: json
            out: addUserTeamResponse
          
        - if: ${addUserTeamResponse.success}
          then:
          - set:
                emailText: "joinTeamSuccess.moustache"
          - set:
        	jiraConfig:
                     jiraTransitionComment: "request process successfully"

  Email:
    - task: smtp
      in:
        mail:
         from: ${senderEmail}
         to: ${senderEmail}
         subject: "Request Process response"
         template: ${emailText}
    - log: ${jira.transition(context, jiraConfig)}
  
forms:
   adminformJoinOrganization:
   - requesterName: { label: "Requester Name", type: "string" ,value : "${requestedUser}" } 
   - orgname: { label: "Organization Name", type: "string" ,value : "${selectedOrg}" } 
   - accept: { label: "Request Accept", type: "string" ,value : "accept" }  

   adminformCreateOrganization:
   - requesterName: { label: "Requester Name", type: "string" ,value : "${requestedUser}" } 
   - orgname: { label: "Organization Name", type: "string" ,value : "${org}" }  
   - accept: { label: "Request Accept", type: "string" ,value : "accept" }  
   - userList: { label: "User List", type: "string" ,value : "${userlist}" }   


              
