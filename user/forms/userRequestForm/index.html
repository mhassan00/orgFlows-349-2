<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="data.js"></script>
    <title>User Request Form</title>


    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
    <script src="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.css"/>
</head>
<body>

<h1 class="ui center aligned header">User Requested Form for create and join in organization</h1>

<div class="ui text center aligned container">

</div>

<div class="ui text container">
    <div class="ui segment">
        <div id="container">
            <script id="formTemplate" type="text/x-handlebars-template">
                {{#if success}}
                <h3 id="success" class="ui header">Success</h3>
                {{else}}
                <form class="ui form {{#if errors}}error{{/if}}" method="post" action="{{submitUrl}}">

                    {{#if errors}}
                    <div class="ui error message">
                        <ul class='list'>
                            {{#each errors}}
                            <li>{{this}}</li>
                            {{/each}}
                        </ul>
                    </div>
                    {{/if}}
                    

                    <div class="field {{#if errors.user}}error{{/if}}">
                        <label>User name:</label>
                        <input name="user" value="{{values.user}}" readOnly/>
                    </div>
                    <div class="field">
                        <label>Select Request Type:</label>
                        <select name="requestType" id="requestType">
                            <option value="select" onclick="hide()">Select</option>
                            <option value="create" onclick="shownew()">CREATE ORGANIZATION</option>
                            <option value="join" onclick="showadd()">JOIN ORGANIZATION</option>

                        </select>
                    </div>
                    <div id="create" style="display:none">
                        <div>
                        <label>Organization Name</label>
                        <input name="org" type="text" id="org" onfocusout="isOrganizationExist()"/>
                         <div class="ui error message" id="orgerror" style="display:none">
                         Organization name already exist
                         </div>
                    </div>
                    <div >
                        <label>User List</label>
                        <input name="userlist" value="{{values.userlist}}" id="userlist" type="text"/>
                    </div>
                    </div>
                    <div id="addorg" style="display:none">
			<label>Select organization</label>
                        <select id="selectedOrg" name="selectedOrg">
                            <option value="select">Select Org</option>

            </select>
	     <div class="ui error message" id="orgSelecterror" style="display:none">
                         Please select an organization from dropdown
                         </div>
                    </div>
<br><br>
                    <button class="ui button" type="reset">Reset</button>
                    <button class="ui primary button" type="submit" onclick="handleSubmit(event)">Submit</button>
                </form>
                {{/if}}
            </script>
        </div>
    </div>

    <img class="ui centered image small" src="../shared/logo.png"/>
</div>

<script>

function shownew(){
     document.getElementById("create").style.display = "block";
     document.getElementById("addorg").style.display = "none";
}

function hide(){
    document.getElementById("create").style.display = "none";
    document.getElementById("addorg").style.display = "none";
}
    
function getOrganization(){
      $.ajax({
        url:data.values.apiBaseUrl+"org",
        success: function(data) {

            select = document.getElementById( 'selectedOrg' );
	    if (select.length >= 0) {
    			select.remove(select.length-1);
	    }
	    select.remove(0);
            var i;
	   select.add( new Option( "select" ) );
            for (i = 0; i < data.length; i++) {
		console.log(select[i]);
                select.add( new Option( data[i].name ) );
            };
        }
    });
}
    
 function isOrganizationExist(){
     var orgValue = document.getElementById("org").value;
      $.ajax({
        url: data.values.apiBaseUrl+"org/"+orgValue,
        success: function(data) {
            if(!data){
                document.getElementById("orgerror").style.display = "none";
               }else{
                  
                   document.getElementById("orgerror").style.display = "block";
               }
        }
      });
}

function showadd(){
     getOrganization();
     document.getElementById("org").value = "test";
     document.getElementById("create").style.display = "none";
     document.getElementById("addorg").style.display = "block";
}

function handleSubmit(ev) {
       var error = false;
       if(document.getElementById("requestType").value === "create"){
	       if(document.getElementById("org").value === "" || document.getElementById("userlist").value === "" || document.getElementById("userlist").value === "enter comma seprated user list ")
	       {
		       error = true;
		       document.getElementById("selectedOrg").value = "select";
	       }
       }
       if(document.getElementById("requestType").value === "join"){
	       if(document.getElementById("selectedOrg").value === ""){    
		     document.getElementById("orgSelecterror").style.display = "block";
	       }else{
		     document.getElementById("orgSelecterror").style.display = "none";

	       }
		       
	       
       }
       if(document.getElementById("orgerror").style.display === "none" && error ===  false){
           var button = ev.target;
           var form = button.parentElement;
           form.classList.add("loading");
       }else{
           ev.preventDefault();
       }
    }

    var source = document.getElementById("formTemplate").innerHTML;
    var template = Handlebars.compile(source);
    var html = template(data);

    document.getElementById("container").innerHTML = html;

    $('.ui.dropdown').dropdown();

</script>

</body>
</html>
